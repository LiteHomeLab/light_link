# P1: State Management (KV) Examples Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Create state management examples using NATS KV (Key-Value) store in Go, C#, and Python that demonstrate how to store, retrieve, and watch state changes.

**Architecture:**
- Three separate examples (Go, C#, Python) under `notify/` directory
- Each example demonstrates:
  - Setting state values
  - Getting state values
  - Watching for state changes
  - Using multiple keys

**Tech Stack:**
- Go 1.21+
- C# .NET 8.0
- Python 3.8+
- NATS JetStream KV

**Reference:** `examples/state-demo/main.go` (SDK example)

---

## Task 1: Create Directory Structure

**Files:**
- Create: `light_link_platform/examples/notify/go/state-demo/`
- Create: `light_link_platform/examples/notify/python/state-demo/`
- Note: C# already has PubSubDemo, we'll add state example there

**Step 1: Create directories**

Run:
```bash
mkdir -p light_link_platform/examples/notify/go/state-demo
mkdir -p light_link_platform/examples/notify/python/state_demo
```

**Step 2: Verify directories created**

Run: `ls light_link_platform/examples/notify/`
Expected: go/state-demo/, python/state_demo/, csharp/

**Step 3: Commit**

```bash
git add light_link_platform/examples/notify/go/state-demo/
git add light_link_platform/examples/notify/python/state_demo/
git commit -m "feat(notify): create state management directories"
```

---

## Task 2: Implement Go State Management Example

**Files:**
- Create: `light_link_platform/examples/notify/go/state-demo/main.go`
- Create: `light_link_platform/examples/notify/go/state-demo/run.bat`

**Step 1: Write Go state example**

```go
package main

import (
	"context"
	"fmt"
	"log"
	"time"

	"github.com/LiteHomeLab/light_link/examples"
	"github.com/LiteHomeLab/light_link/sdk/go/client"
	"github.com/WQGroup/logger"
)

func main() {
	logger.SetLoggerName("state-demo-go")
	logger.Info("=== State Management Demo (Go) ===")

	config := examples.GetConfig()
	logger.Infof("NATS URL: %s", config.NATSURL)

	// Create client
	logger.Info("Connecting to NATS...")
	cli, err := client.NewClient(config.NATSURL, client.WithAutoTLS())
	if err != nil {
		log.Fatalf("Failed to create client: %v", err)
	}
	defer cli.Close()
	logger.Info("Connected successfully")

	// Set some state values
	logger.Info("\n[1/4] Setting state values...")
	err = cli.SetState("config", map[string]interface{}{
		"version":    "1.0.0",
		"environment": "production",
		"debug":       false,
		"max_connections": 100,
	})
	if err != nil {
		log.Fatalf("Failed to set config state: %v", err)
	}
	logger.Info("✓ Set 'config' state")

	err = cli.SetState("user:123", map[string]interface{}{
		"name":      "Alice",
		"email":     "alice@example.com",
		"role":      "admin",
		"login_count": 42,
	})
	if err != nil {
		log.Fatalf("Failed to set user state: %v", err)
	}
	logger.Info("✓ Set 'user:123' state")

	err = cli.SetState("counter", map[string]interface{}{
		"value": 0,
		"incremented_by": []string{"user1", "user2", "user3"},
	})
	if err != nil {
		log.Fatalf("Failed to set counter state: %v", err)
	}
	logger.Info("✓ Set 'counter' state")

	// Get state values
	logger.Info("\n[2/4] Getting state values...")

	configState, err := cli.GetState("config")
	if err != nil {
		log.Printf("Failed to get config state: %v", err)
	} else {
		logger.Info("Config state:")
		for k, v := range configState {
			logger.Infof("  %s: %v", k, v)
		}
	}

	userState, err := cli.GetState("user:123")
	if err != nil {
		log.Printf("Failed to get user state: %v", err)
	} else {
		logger.Info("User state:")
		for k, v := range userState {
			logger.Infof("  %s: %v", k, v)
		}
	}

	// Watch for state changes
	logger.Info("\n[3/4] Watching for state changes...")
	ctx, cancel := context.WithTimeout(context.Background(), 10*time.Second)
	defer cancel()

	err = cli.WatchState("counter", func(state map[string]interface{}) {
		logger.Infof("State changed: %+v", state)
	})
	if err != nil {
		log.Printf("Failed to watch state: %v", err)
	}

	// Update state to trigger watch
	logger.Info("\n[4/4] Updating state to trigger watch...")
	for i := 1; i <= 3; i++ {
		time.Sleep(1 * time.Second)
		err = cli.SetState("counter", map[string]interface{}{
			"value":          i,
			"incremented_by": []string{"user1", "user2", "user3"},
			"timestamp":      time.Now().Format(time.RFC3339),
		})
		if err != nil {
			log.Printf("Failed to update counter: %v", err)
		}
		logger.Infof("✓ Updated counter to %d", i)
	}

	// Keep watching for a bit
	time.Sleep(2 * time.Second)

	logger.Info("\n=== Demo complete ===")
}
```

**Step 2: Create run.bat**

```bat
@echo off
echo Starting Go State Management Demo...
go run main.go
pause
```

**Step 3: Test the example**

Run: `go run main.go`
Expected: Sets, gets, and watches state changes

**Step 4: Commit**

```bash
git add light_link_platform/examples/notify/go/state-demo/
git commit -m "feat(notify): add Go state management example"
```

---

## Task 3: Implement Python State Management Example

**Files:**
- Create: `light_link_platform/examples/notify/python/state_demo/main.py`
- Create: `light_link_platform/examples/notify/python/state_demo/run.bat`

**Step 1: Check if Python SDK has state management methods**

Run: `grep -n "def.*[Ss]tate\|kv\|KV" sdk/python/lightlink/client.py`
Expected: Check if methods exist or need to be implemented

**Step 2: Write Python state example**

```python
#!/usr/bin/env python3
"""
LightLink Python State Management Example

Demonstrates using NATS KV for state management.
"""

import asyncio
import logging
import os
import sys
import time
from datetime import datetime

# Add parent directory to path for imports
sys.path.insert(0, os.path.join(os.path.dirname(__file__), '../../..'))

from lightlink.client import Client, discover_client_certs

# Configure logging
logging.basicConfig(
    level=logging.INFO,
    format='[%(name)s] %(message)s'
)
logger = logging.getLogger('state-demo-python')


async def main():
    logger.info("=== State Management Demo (Python) ===")

    # Configuration
    nats_url = os.getenv('NATS_URL', 'nats://172.18.200.47:4222')
    logger.info(f"NATS URL: {nats_url}")

    # Discover certificates
    logger.info("\nDiscovering TLS certificates...")
    try:
        certs = discover_client_certs()
        logger.info(f"Certificates found: {certs.cert_file}")
    except FileNotFoundError as e:
        logger.error(f"Certificates not found: {e}")
        return

    # Create client
    logger.info("\nConnecting to NATS...")
    client = Client(nats_url)
    await client.connect(
        tls_cert_file=certs.cert_file,
        tls_key_file=certs.key_file,
        tls_ca_file=certs.ca_file
    )
    logger.info("Connected successfully")

    # Set some state values
    logger.info("\n[1/4] Setting state values...")
    try:
        await client.set_state("config", {
            "version": "1.0.0",
            "environment": "production",
            "debug": False,
            "max_connections": 100
        })
        logger.info("✓ Set 'config' state")
    except AttributeError:
        logger.error("set_state method not found in Python SDK")
        logger.info("Please implement state management in Python SDK first")
        return
    except Exception as e:
        logger.error(f"Failed to set config state: {e}")

    try:
        await client.set_state("user:123", {
            "name": "Bob",
            "email": "bob@example.com",
            "role": "user",
            "login_count": 15
        })
        logger.info("✓ Set 'user:123' state")
    except Exception as e:
        logger.error(f"Failed to set user state: {e}")

    try:
        await client.set_state("counter", {
            "value": 0,
            "incremented_by": ["user1", "user2"]
        })
        logger.info("✓ Set 'counter' state")
    except Exception as e:
        logger.error(f"Failed to set counter state: {e}")

    # Get state values
    logger.info("\n[2/4] Getting state values...")

    try:
        config = await client.get_state("config")
        logger.info("Config state:")
        for k, v in config.items():
            logger.info(f"  {k}: {v}")
    except Exception as e:
        logger.error(f"Failed to get config state: {e}")

    try:
        user = await client.get_state("user:123")
        logger.info("User state:")
        for k, v in user.items():
            logger.info(f"  {k}: {v}")
    except Exception as e:
        logger.error(f"Failed to get user state: {e}")

    # Watch for state changes
    logger.info("\n[3/4] Watching for state changes...")
    watch_started = False

    try:
        # Start watching in background
        async def watch_handler(state):
            logger.info(f"State changed: {state}")

        await client.watch_state("counter", watch_handler)
        watch_started = True
        logger.info("Watching 'counter' state...")
    except AttributeError:
        logger.warning("watch_state method not found in Python SDK")
    except Exception as e:
        logger.error(f"Failed to watch state: {e}")

    # Update state to trigger watch
    logger.info("\n[4/4] Updating state to trigger watch...")
    for i in range(1, 4):
        await asyncio.sleep(1)
        try:
            await client.set_state("counter", {
                "value": i,
                "incremented_by": ["user1", "user2"],
                "timestamp": datetime.now().isoformat()
            })
            logger.info(f"✓ Updated counter to {i}")
        except Exception as e:
            logger.error(f"Failed to update counter: {e}")

    # Keep watching for a bit
    if watch_started:
        await asyncio.sleep(2)

    # Cleanup
    await client.close()
    logger.info("\n=== Demo complete ===")


if __name__ == '__main__':
    asyncio.run(main())
```

**Step 3: Create run.bat**

```bat
@echo off
echo Starting Python State Management Demo...
python main.py
pause
```

**Step 4: Test the example**

Run: `python main.py`
Expected: Sets, gets, and watches state changes
Note: May fail if Python SDK doesn't have state management methods

**Step 5: Commit**

```bash
git add light_link_platform/examples/notify/python/state_demo/
git commit -m "feat(notify): add Python state management example"
```

---

## Task 4: Add State Management to C# PubSubDemo

**Files:**
- Create: `light_link_platform/examples/notify/csharp/StateDemo/`
- Create: `light_link_platform/examples/notify/csharp/StateDemo/StateDemo.csproj`
- Create: `light_link_platform/examples/notify/csharp/StateDemo/Program.cs`
- Create: `light_link_platform/examples/notify/csharp/StateDemo/run.bat`

**Step 1: Create .csproj file**

```xml
<Project Sdk="Microsoft.NET.Sdk">

  <PropertyGroup>
    <OutputType>Exe</OutputType>
    <TargetFramework>net8.0</TargetFramework>
    <ImplicitUsings>enable</ImplicitUsings>
    <Nullable>enable</Nullable>
  </PropertyGroup>

  <ItemGroup>
    <ProjectReference Include="../../../../../sdk/csharp/LightLink/LightLink.csproj" />
  </ItemGroup>

</Project>
```

**Step 2: Write Program.cs**

```csharp
using System;
using System.Threading.Tasks;
using LightLink;

namespace StateDemo
{
    class Program
    {
        static async Task Main(string[] args)
        {
            Console.WriteLine("=== State Management Demo (C#) ===");

            // Configuration
            string natsUrl = Environment.GetEnvironmentVariable("NATS_URL")
                ?? "nats://172.18.200.47:4222";
            Console.WriteLine($"NATS URL: {natsUrl}");

            // Discover certificates
            Console.WriteLine("\nDiscovering TLS certificates...");
            var tlsResult = CertDiscovery.DiscoverClientCerts();
            if (!tlsResult.Found)
            {
                Console.WriteLine("ERROR: Client certificates not found!");
                return;
            }
            var tlsConfig = CertDiscovery.ToTLSConfig(tlsResult);

            // Create client
            Console.WriteLine("\nConnecting to NATS...");
            var client = new Client(natsUrl, tlsConfig);
            await client.ConnectAsync();
            Console.WriteLine("Connected successfully");

            // Set some state values
            Console.WriteLine("\n[1/4] Setting state values...");

            try
            {
                client.SetState("config", new Dictionary<string, object>
                {
                    { "version", "1.0.0" },
                    { "environment", "production" },
                    { "debug", false },
                    { "max_connections", 100 }
                });
                Console.WriteLine("✓ Set 'config' state");
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Failed to set config state: {ex.Message}");
            }

            try
            {
                client.SetState("user:456", new Dictionary<string, object>
                {
                    { "name", "Charlie" },
                    { "email", "charlie@example.com" },
                    { "role", "moderator" },
                    { "login_count", 28 }
                });
                Console.WriteLine("✓ Set 'user:456' state");
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Failed to set user state: {ex.Message}");
            }

            try
            {
                client.SetState("counter", new Dictionary<string, object>
                {
                    { "value", 0 },
                    { "incremented_by", new[] { "user1", "user2" } }
                });
                Console.WriteLine("✓ Set 'counter' state");
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Failed to set counter state: {ex.Message}");
            }

            // Get state values
            Console.WriteLine("\n[2/4] Getting state values...");

            try
            {
                var config = client.GetState("config");
                Console.WriteLine("Config state:");
                foreach (var kvp in config)
                {
                    Console.WriteLine($"  {kvp.Key}: {kvp.Value}");
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Failed to get config state: {ex.Message}");
            }

            try
            {
                var user = client.GetState("user:456");
                Console.WriteLine("User state:");
                foreach (var kvp in user)
                {
                    Console.WriteLine($"  {kvp.Key}: {kvp.Value}");
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Failed to get user state: {ex.Message}");
            }

            // Update state multiple times
            Console.WriteLine("\n[3/4] Updating state multiple times...");
            for (int i = 1; i <= 3; i++)
            {
                await Task.Delay(1000);
                try
                {
                    client.SetState("counter", new Dictionary<string, object>
                    {
                        { "value", i },
                        { "incremented_by", new[] { "user1", "user2" } },
                        { "timestamp", DateTime.Now.ToString("o") }
                    });
                    Console.WriteLine($"✓ Updated counter to {i}");
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"Failed to update counter: {ex.Message}");
                }
            }

            // Get final state
            Console.WriteLine("\n[4/4] Getting final counter state...");
            try
            {
                var counter = client.GetState("counter");
                Console.WriteLine("Final counter state:");
                foreach (var kvp in counter)
                {
                    Console.WriteLine($"  {kvp.Key}: {kvp.Value}");
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Failed to get counter state: {ex.Message}");
            }

            // Cleanup
            client.Close();
            Console.WriteLine("\n=== Demo complete ===");
            Console.WriteLine("\nPress any key to exit...");
            Console.ReadKey();
        }
    }
}
```

**Step 3: Create run.bat**

```bat
@echo off
echo Starting C# State Management Demo...
dotnet run
pause
```

**Step 4: Build and test**

Run: `dotnet build && dotnet run`
Expected: Sets, gets, and updates state values

**Step 5: Commit**

```bash
git add light_link_platform/examples/notify/csharp/StateDemo/
git commit -m "feat(notify): add C# state management example"
```

---

## Task 5: Update Notify README

**Files:**
- Modify: `light_link_platform/examples/notify/README.md`

**Step 1: Update README with state management examples**

```markdown
# Notify - 消息通知与状态管理

本目录包含使用消息发布订阅和状态管理的示例程序。

## 示例项目

| 语言 | 发布订阅 | 状态管理 (KV) | 说明 |
|------|----------|--------------|------|
| Go | - | ✅ state-demo | KV 状态存储和监听 |
| C# | ✅ PubSubDemo | ✅ StateDemo | 发布订阅和状态管理 |
| Python | - | ✅ state_demo | KV 状态存储和监听 |

## 状态管理功能

### 1. 存储状态
使用 `SetState()` 方法存储键值对数据：
- 配置信息
- 用户状态
- 计数器
- 任何需要持久化的数据

### 2. 获取状态
使用 `GetState()` 方法读取存储的值：
- 按键名获取
- 返回完整的状态字典

### 3. 监听状态变化
使用 `WatchState()` 方法监听状态变化：
- 实时接收更新通知
- 适用于配置热更新
- 分布式状态同步

## 运行示例

### Go 状态管理
```bash
cd light_link_platform/examples/notify/go/state-demo
go run main.go
```

### C# 状态管理
```bash
cd light_link_platform/examples/notify/csharp/StateDemo
dotnet run
```

### Python 状态管理
```bash
cd light_link_platform/examples/notify/python/state_demo
python main.py
```

## 功能对比

| 功能 | Pub/Sub | KV (状态) |
|------|---------|-----------|
| 实时性 | 实时 | 按需 |
| 持久化 | 否 | 是 |
| 消息历史 | 否 | 最后值 |
| 离线接收 | 错过 | 可获取 |
| 典型场景 | 通知 | 状态同步 |
```

**Step 2: Commit**

```bash
git add light_link_platform/examples/notify/README.md
git commit -m "docs(notify): update README with state management examples"
```

---

## Testing Strategy

### Prerequisites
- NATS server with JetStream enabled
- TLS certificates in `client/` folder

### Test Each Language

```bash
# Go
cd light_link_platform/examples/notify/go/state-demo
go run main.go

# C#
cd light_link_platform/examples/notify/csharp/StateDemo
dotnet run

# Python
cd light_link_platform/examples/notify/python/state_demo
python main.py
```

### Expected Behavior

All examples should:
1. Set multiple state values
2. Retrieve state values
3. Update state to demonstrate changes
4. Show state watch functionality (if implemented)

---

## Dependencies

### Go
- Go 1.21+
- LightLink Go SDK

### C#
- .NET 8.0
- LightLink C# SDK (with Client.cs from P0)

### Python
- Python 3.8+
- nats-py
- LightLink Python SDK
- **Note**: State management methods may need to be implemented in Python SDK first

---

## Related Plans

- P0: `2024-12-26-restore-csharp-client.md` (C# SDK Client required)
- P2 Python SDK State: Full implementation of state management in Python SDK

---

## Acceptance Testing via Management Platform

**IMPORTANT:** All development plans must be verified through the management platform.

### Step 1: Start Management Platform Backend

```bash
cd light_link_platform/manager_base/server
go run main.go
```

Wait for the backend server to start.

### Step 2: Start Management Platform Frontend

```bash
cd light_link_platform/manager_base/web
npm run dev
```

Wait for the frontend to start.

### Step 3: Open Browser and Verify

1. Open browser to the frontend URL
2. Navigate to the State/KV section
3. Verify that:
   - State keys are displayed in the KV store viewer
   - State values can be viewed and edited
   - State change history is visible

### Step 4: Test State Management Flow

1. Run a state management example (Go/C#/Python)
2. Observe in the management platform:
   - State values being set
   - State updates in real-time
   - Watch notifications when state changes

### Step 5: Capture Evidence

Take screenshots showing state operations in the management platform dashboard.
